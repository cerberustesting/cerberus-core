<!-- Modal Component -->
<div
        x-data="testCaseModal()"
        x-init="init()"
        x-show="open"
        x-cloak
        @testcase-modal-open.window="open = true; setDefaultTest($event.detail.defaultTest);"
        class="crb_modal">

    <!-- Overlay -->
    <div class="absolute inset-0 bg-slate-900 opacity-60" @click="open = false"></div>

    <!-- Modal -->
    <div class="crb_card w-full max-w-4xl mx-4"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 scale-100"
         x-transition:leave-end="opacity-0 scale-95"
         @click.away="open = false">

        <!-- Header -->
        <div class="flex justify-between items-center px-6 py-4 mb-8">
            <div class="flex flex-col">
                <h3 class="text-xl font-semibold">Create Test Case</h3>
                <p class="page-subtitle-line">Configure your test case settings before designing the test steps</p>
            </div>
            <button @click="open = false" class="hover:text-gray-700">&times;</button>
        </div>

        <!-- Stepper -->
        <div class="w-full flex bg-slate-200 dark:bg-slate-700 p-1 rounded-lg shadow-sm mb-8 h-10">
            <template x-for="(label, index) in steps" :key="index">
                <button @click="step = index"
                        :class="step === index ? 'bg-slate-50 font-semibold dark:bg-slate-900' : 'bg-slate-200 dark:bg-slate-700 text-slate-700 hover:text-slate-900 dark:text-slate-300 dark:hover:text-white'"
                        class="flex-1 flex items-center justify-center px-4 py-2 rounded-md transition-colors duration-200 gap-2">
                    <template x-if="completedSteps.includes(index)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                        </svg>
                    </template>
                    <span x-text="label"></span>
                </button>
            </template>
        </div>

        <!-- Body -->
        <div class="p-6 space-y-6">
            <template x-if="errorMessage">
                <div class="bg-red-100 text-red-800 p-2 rounded flex justify-between items-center">
                    <strong x-text="errorMessage"></strong>
                    <button @click="errorMessage=''" class="ml-2">&times;</button>
                </div>
            </template>

            <form @submit.prevent="submitForm()" class="space-y-4">

                <!-- Step 1: Application -->
                <div x-show="step === 0" class="space-y-4" x-data="{ open: false, creatingApplication: false }">

                    <div class="p-4 space-y-2">
                        <div class="font-semibold">Choose the application</div>

                        <!-- Bloc SELECTION d'application existante -->
                        <div x-show="!creatingApplication" x-transition>
                            <div class="relative" @click.away="open = false">

                                <!-- Bouton dropdown -->
                                <button type="button"
                                        @click="open = !open"
                                        id="editTestCaseSimpleCreationApplication"
                                        class="flex h-10 items-center justify-between w-full rounded-md border px-3 py-2 text-sm
                dark:bg-slate-800 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700
                bg-white border-slate-300 text-slate-900 hover:bg-slate-100 transition-all">
                                    <span x-text="applicationDropdown.selectedLabel()"></span>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-2"
                                         fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
                                    </svg>
                                </button>

                                <!-- Liste dropdown -->
                                <div x-show="open" x-transition
                                     class="absolute mt-1 w-full rounded-md border shadow-lg z-50
                     dark:bg-slate-800 dark:border-slate-600 dark:text-slate-300
                     bg-white border-slate-300 text-slate-900 max-h-48 overflow-auto">
                                    <template x-for="item in applicationDropdown.items" :key="item">
                                        <div>
                                            <button type="button"
                                                    :id="`editTestCaseSimpleCreationApplication_${item}`"
                                                    @click="applicationDropdown.select(item); form.application = item; nextStepIfValid('application'); open=false"
                                                    class="w-full flex items-center gap-2 px-3 py-2 dark:hover:bg-slate-700 hover:bg-slate-100 transition-colors">
                                                <span x-text="item"></span>
                                            </button>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- Bouton "Cr√©er une nouvelle application" -->
                            <div class="mt-2">
                                <button type="button"
                                        @click="creatingApplication = true; form.application=''; open=false"
                                        class="text-sm text-blue-600 hover:underline">
                                    + Create a new application
                                </button>
                            </div>
                        </div>

                        <!-- Bloc CREATION d'une nouvelle application -->
                        <div x-show="creatingApplication" x-transition
                             class="space-y-2 mt-4 rounded p-4 bg-slate-50 dark:bg-slate-800"
                             x-init="
                                    $watch('form.application', checkAllFilled);
                                    $watch('form.type', checkAllFilled);
                                    $watch('form.url', checkAllFilled);
                                    $watch('form.country', checkAllFilled);
                                    $watch('form.environment', checkAllFilled);

                                    function checkAllFilled() {
                                        if(form.application && form.type && form.url && form.country && form.environment) {
                                            nextStepIfValid('application');
                                        }
                                    }
                                 ">
                            <!-- Ligne 1 : Name + URL -->
                            <div class="flex gap-2 flex-wrap">
                                <div class="flex-[1_1_33%] min-w-[150px]">
                                    <label>Name</label>
                                    <input type="text" x-model="form.application" class="w-full border rounded px-2 py-1 h-10 dark:bg-slate-800 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700
                               bg-white border-slate-300 text-slate-900 hover:bg-slate-100 transition-all">
                                </div>
                                <div class="flex-[2_1_66%] min-w-[200px]">
                                    <label>URL</label>
                                    <input type="text" x-model="form.url" class="w-full border rounded px-2 py-1 h-10 dark:bg-slate-800 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700
                               bg-white border-slate-300 text-slate-900 hover:bg-slate-100 transition-all">
                                </div>
                            </div>

                            <!-- Ligne 2 : Type + Country + Environment -->
                            <div class="flex gap-2 flex-wrap mt-2">
                                <div class="flex-1 min-w-[120px]">
                                    <label>Type</label>
                                    <select name="editTestCaseSimpleCreationApplicationType"
                                            x-model="form.type"
                                            class="w-full border rounded px-2 py-1 h-10 dark:bg-slate-800 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700
                               bg-white border-slate-300 text-slate-900 hover:bg-slate-100 transition-all">
                                    </select>
                                </div>
                                <div class="flex-1 min-w-[120px]">
                                    <label>Country</label>
                                    <select name="editTestCaseSimpleCreationCountry"
                                            x-model="form.country"
                                            class="w-full border rounded px-2 py-1 h-10 dark:bg-slate-800 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700
                               bg-white border-slate-300 text-slate-900 hover:bg-slate-100 transition-all">
                                    </select>
                                </div>
                                <div class="flex-1 min-w-[120px]">
                                    <label>Environment</label>
                                    <select name="editTestCaseSimpleCreationEnvironment"
                                            x-model="form.environment"
                                            class="w-full border rounded px-2 py-1 h-10 dark:bg-slate-800 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700
                               bg-white border-slate-300 text-slate-900 hover:bg-slate-100 transition-all">
                                    </select>
                                </div>
                            </div>

                            <!-- Lien "Choose existing application" -->
                            <div class="flex gap-2 mt-4">
                                <button type="button"
                                        @click="creatingApplication=false; form.application='';"
                                        class="text-sm text-blue-600 hover:underline">
                                    ‚Üê Choose existing application
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Description -->
                <div x-show="step === 1" class="p-4 space-y-2">
                    <label>Describe shortly your TestCase</label>
                    <input type="text" id="editTestCaseSimpleCreationDescription" x-model="form.description" @keyup.enter="nextStepIfValid('description')" placeholder="As a user..."
                           class="w-full h-10 text-sm border rounded px-2 py-1 dark:bg-slate-800 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700
                               bg-white border-slate-300 text-slate-900 hover:bg-slate-100 transition-all">
                </div>

                <!-- Step 3: Folder -->
                <div x-show="step === 2" class="p-4 space-y-2">
                    <div class="flex gap-2 flex-wrap items-end">
                        <!-- Folder dropdown -->
                        <div class="flex-1 min-w-[150px]">
                            <label>Choose (or Create) a folder</label>
                            <div x-data="folderDropdown({ model: form.testFolderId, items: tests })"
                                 x-effect="items = tests"
                                 class="relative w-full">

                                <!-- Bouton principal -->
                                <button type="button"
                                        @click="open = !open"
                                        id="editTestCaseSimpleCreationTestFolder"
                                        class="flex h-10 items-center justify-between w-full rounded-md border px-3 py-2 text-sm
                               dark:bg-slate-800 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700
                               bg-white border-slate-300 text-slate-900 hover:bg-slate-100 transition-all">
                                    <span x-text="selectedLabel()"></span>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-2"
                                         fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
                                    </svg>
                                </button>

                                <!-- Dropdown -->
                                <div x-show="open"
                                     @click.away="open = false"
                                     x-transition
                                     class="absolute mt-1 w-full rounded-md border shadow-lg z-50
                            dark:bg-slate-800 dark:border-slate-600 dark:text-slate-300
                            bg-white border-slate-300 text-slate-900 max-h-64 overflow-hidden">

                                    <!-- Barre de recherche -->
                                    <div class="p-2 border-b dark:border-slate-700">
                                        <input type="text" x-model="search" placeholder="Search or create..."
                                               id="editTestCaseSimpleCreationTestFolderSearch"
                                               class="w-full text-sm border rounded px-2 py-1 dark:bg-slate-700 dark:border-slate-600">
                                    </div>

                                    <!-- Liste / cr√©ation -->
                                    <div class="max-h-52 overflow-auto">

                                        <!-- R√©sultats existants -->
                                        <template x-if="filteredItems().length > 0">
                                            <template x-for="item in filteredItems()" :key="item">
                                                <button type="button"
                                                        :id="`editTestCaseSimpleCreationTestFolder${item}`"
                                                        @click="select(item); form.testFolderId = item; $dispatch('folder-selected', item); $nextTick(() => fetchNextTestCaseId());"
                                                        class="w-full text-left px-3 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 transition">
                                                    <span x-text="item"></span>
                                                </button>
                                            </template>
                                        </template>

                                        <!-- Aucun r√©sultat ‚Üí proposer cr√©ation -->
                                        <template x-if="filteredItems().length === 0">
                                            <button type="button"
                                                    id="editTestCaseSimpleCreationTestFolderNew"
                                                    @click="createNew(); form.testFolderId = selected; $nextTick(() => fetchNextTestCaseId());"
                                                    class="w-full text-left px-3 py-2 text-sm italic hover:bg-slate-100 dark:hover:bg-slate-700 transition">
                                                Create "<span x-text="search"></span>"
                                            </button>
                                        </template>

                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Test Case ID -->
                        <div class="flex-1 min-w-[150px]">
                            <label>Test Case ID</label>
                            <input type="text"
                                   x-model="form.testcaseId"
                                   id="editTestCaseSimpleCreationTestcaseId"
                                   class="w-full border rounded px-3 py-2 text-sm h-10
                          dark:bg-slate-800 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700
                               bg-white border-slate-300 text-slate-900 hover:bg-slate-100 transition-all">
                        </div>

                    </div>
                </div>


            </form>
        </div>

        <!-- Footer -->
        <div class="flex justify-end gap-2 px-6 py-4 mt-8">
            <button @click="prevStep()" :disabled="step === 0" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">Back</button>
            <button @click="step === 2 ? submitForm() : nextStep()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                <span x-text="step === 2 ? 'Create' : 'Next'"></span>
            </button>
        </div>
    </div>
</div>

<script>
    function folderDropdown(config = {}) {
        return {
            open: false,
            search: '',
            items: config.items || [],
            selected: config.model ?? '',
            model: config.model ?? '',

            filteredItems() {
                if (!Array.isArray(this.items)) return [];
                const q = this.search.toLowerCase();
                return this.items.filter(i => i.toLowerCase().includes(q));
            },

            select(item) {
                this.selected = item;
                this.model = item;
                this.open = false;
                this.$dispatch('folder-selected', item);
            },

            createNew() {
                if (!this.search.trim()) return;

                const newItem = this.search.trim();

                if (!Array.isArray(this.items)) {
                    this.items = [];
                }

                if (!this.items.includes(newItem)) {
                    this.items.push(newItem);
                }

                this.select(newItem);
            },

            selectedLabel() {
                return this.selected || '-- Select Test Folder --';
            }
        }
    }

    function testCaseModal() {
        return {
            open: false,
            step: 0,
            steps: ['Application', 'Description', 'Folder'],
            completedSteps: [],
            errorMessage: '',
            creatingApplication: false,
            form: {
                application: '',
                type: '',
                url: '',
                country: '',
                environment: '',
                description: '',
                testFolderId: '',
                testcaseId: ''
            },
            applications: [],
            tests: [],
            countries: [],
            environments: [],
            appTypes: [],

            applicationDropdown: { items: [], selected:'', open:false, select(item){ this.selected=item; this.open=false; }, selectedLabel(){ return this.selected || '-- Select --'; } },

            setDefaultTest(test){
                this.form.testFolderId = test || '';
                this.loadApplications();
                this.loadTests();
                this.loadInvariants();
            },

            loadApplications(){
                fetch('ReadApplication')
                    .then(resp=>resp.json())
                    .then(data=>{
                        this.applications = data.contentTable.map(c=>c.application);
                        this.applicationDropdown.items = this.applications;
                    });
            },

            loadTests(){
                fetch('ReadTest?iSortCol_0=0&sSortDir_0=asc&sColumns=test&iDisplayLength=100')
                    .then(resp => resp.json())
                    .then(data => {
                        this.tests = data.contentTable.map(obj => obj.test);
                    });
            },

            loadInvariants() {
                this.$nextTick(() => {
                    const root = this.$root;


                    root.querySelectorAll("[name='editTestCaseSimpleCreationApplicationType']").forEach(el => el.innerHTML = '');
                    root.querySelectorAll("[name='editTestCaseSimpleCreationCountry']").forEach(el => el.innerHTML = '');
                    root.querySelectorAll("[name='editTestCaseSimpleCreationEnvironment']").forEach(el => el.innerHTML = '');


                    displayInvariantList("editTestCaseSimpleCreationApplicationType", "APPLITYPE", false);
                    displayInvariantList("editTestCaseSimpleCreationCountry", "COUNTRY", false);
                    displayInvariantList("editTestCaseSimpleCreationEnvironment", "ENVIRONMENT", false);
                });
            },

            fetchNextTestCaseId(){
                if(!this.form.testFolderId) return;
                fetch(`ReadTestCase?test=${encodeURIComponent(this.form.testFolderId)}&getMaxTC=true`)
                    .then(resp=>resp.json())
                    .then(data=>{ this.form.testcaseId = data.nextAvailableTestcaseId || ''; });
            },

            validateStep(field){
                switch(field){
                    case 'application': return !!this.form.application;
                    case 'description': return !!this.form.description;
                    case 'testFolderId': return !!this.form.testFolderId && !!this.form.testcaseId;
                }
                return true;
            },

            nextStepIfValid(field){
                if(this.validateStep(field)){
                    if(!this.completedSteps.includes(this.step)) this.completedSteps.push(this.step);
                    this.nextStep();
                }
            },

            nextStep(){ if(this.step<2) this.step++; },
            prevStep(){ if(this.step>0) this.step--; },

            validateForm(){
                if(!this.form.application){ this.errorMessage="Please specify the application!"; return false; }
                if(!this.form.testFolderId){ this.errorMessage="Please specify the test folder!"; return false; }
                if(!this.form.testcaseId){ this.errorMessage="Please specify the Testcase ID!"; return false; }
                if(this.form.testFolderId.includes('&')){ this.errorMessage="Test folder name cannot contain &"; return false; }
                if(this.form.testcaseId.includes('&')){ this.errorMessage="Testcase ID cannot contain &"; return false; }
                this.errorMessage='';
                return true;
            },

            submitForm(){
                if(!this.validateForm()) return;
                const data = {...this.form, system: getUser().defaultSystem};

                fetch('api/public/testcases/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-API-VERSION': 1},
                    body: JSON.stringify(data)
                })
                    .then(resp => resp.json())
                    .then(respData => {
                        console.log("Create response:", respData);

                        // üîπ Tol√®re les 2 conventions de Cerberus : "OK" ou "success"
                        if (respData.messageType === 'success' || respData.messageType === 'OK') {
                            if (respData.test && respData.testcase) {
                                window.location.href = `./TestCaseScript.jsp?test=${encodeURIComponent(respData.test)}&testcase=${encodeURIComponent(respData.testcase)}&oneclickcreation=true`;
                            } else {
                                this.errorMessage = "‚úÖ TestCase created successfully, but redirect info is missing.";
                                console.warn("Missing test/testcase in response.");
                            }
                        } else {
                            this.errorMessage = respData.message || "Error during creation.";
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        this.errorMessage = "Unexpected error!";
                    });
            },

            init(){
                this.loadApplications();
                this.loadTests();
                this.loadInvariants();
            }
        }
    }
</script>