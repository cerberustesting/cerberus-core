<div x-data="aoModal()"
     x-show="open"
     x-cloak
     @open-ao.window="openModal($event.detail)"
     class="crb_modal" xmlns="http://www.w3.org/1999/html">

    <!-- Overlay -->
    <div class="absolute inset-0 bg-slate-900/80" @click="close()"></div>

    <!-- Card -->
    <div id="aoModalCard" :class="isFullscreen  ? 'w-full h-full rounded-none' : 'crb_card w-full max-w-5xl h-[85vh] rounded-2xl'"
         class="relative bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 shadow-2xl flex flex-col overflow-hidden transition-all duration-300"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 scale-100"
         x-transition:leave-end="opacity-0 scale-95"
         @click.away="open = false">

        <!-- HEADER -->
        <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200 dark:border-slate-700">

            <!-- LEFT -->
            <div class="flex items-center gap-3">

                <!-- ICON -->
                <div class="h-10 w-10 rounded-xl bg-blue-600/10 flex items-center justify-center">
                    <i data-lucide="box"
                       class="w-5 h-5 text-blue-600"></i>
                </div>

                <div>
                    <h2 class="text-lg font-semibold" x-text="$store.labels.getLabel('applicationObject','modaltitle')"></h2>
                    <p class="text-xs text-slate-500" x-text="$store.labels.getLabel('applicationObject','modalsubtitle')"></p>
                </div>
            </div>

            <!-- ACTIONS -->
            <div class="flex items-center gap-2">

                <!-- FULLSCREEN -->
                <button @click="isFullscreen = !isFullscreen" class="h-9 w-9 rounded-lg flex items-center justify-center text-slate-500 hover:text-blue-600 hover:bg-slate-100 dark:hover:bg-slate-800 transition">
                    <i :data-lucide="isFullscreen ? 'minimize-2' : 'maximize-2'" class="w-4 h-4"></i>
                </button>

                <!-- CLOSE -->
                <button @click="close()" class="h-9 w-9 rounded-lg flex items-center justify-center text-slate-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 transition">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
        </div>

        <!-- BODY -->
        <div class="flex flex-col flex-1 overflow-hidden">

            <!-- NOTIFY ANCHOR -->
            <div id="modalNotify"></div>

            <!-- CONTEXT -->
            <div class="border-slate-200 dark:border-slate-700 transition-all duration-300 overflow-hidden"
                 :class="contextReady ? 'p-3 max-h-[140px]' : 'p-6 max-h-[420px]'">

                <!-- HEADER -->
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-semibold uppercase tracking-wider text-slate-500" x-text="$store.labels.getLabel('applicationObject','modalcontext')"></span>
                    <span class="text-[10px] bg-slate-200 dark:bg-slate-700 rounded-full px-2 py-0.5">
                        <span x-text="(screenshotFile?1:0) + (htmlFile?1:0) + ' ' + $store.labels.getLabel('applicationObject','file')"></span>
                    </span>
                </div>

                <!-- MODE EDIT -->
                <div x-show="!contextReady">

                    <div class="space-y-4">

                        <!-- UPLOAD -->
                        <div class="rounded-xl border border-dashed border-slate-300 dark:border-slate-600 p-6 text-center hover:border-blue-500 transition cursor-pointer"
                             @click="$refs.fileInput.click()">
                            <input type="file" x-ref="fileInput" multiple class="hidden" @change="handleFiles($event)">
                            <i data-lucide="upload" class="w-8 h-8 mx-auto text-slate-400 mb-3"></i>
                            <p class="text-sm text-slate-500" x-text="$store.labels.getLabel('applicationObject','upload')"></p>
                            <p class="text-xs text-slate-400 mt-1" x-text="$store.labels.getLabel('applicationObject','clicktoselect')"></p>
                        </div>

                        <!-- APPLICATION / PAGE -->
                        <div class="flex gap-4">
                            <div class="w-1/2">
                                <label class="font-semibold block mb-1" x-text="$store.labels.getLabel('applicationObject','application')"></label>
                                <div x-data="singleSelectDropdown({
                                id: 'aoApplicationSelect',
                                    loader: async () => {
                                        try {
                                            const r = await fetch('ReadApplication');
                                            const d = await r.json();
                                            console.log(d);
                                            return d.contentTable.map(a => a.application);
                                        } catch (e) {
                                            console.error('Failed to load applications :', e);
                                            return [];
                                        }
                                    }
                                })"
                                     x-modelable="selectedValue"
                                     x-model="application">
                                </div>
                            </div>

                            <div class="w-1/2">
                                <label class="font-semibold block mb-1" x-text="$store.labels.getLabel('applicationObject','webpage')"></label>
                                <input type="text"
                                       x-model="page"
                                       :placeholder="$store.labels.getLabel('applicationObject','webpageplaceholder')"
                                       class="h-10 w-full bg-slate-100 dark:bg-slate-800 rounded-lg px-3 py-2"/>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- MODE COMPACT -->
                <div x-show="contextReady">
                    <div class="flex items-center text-sm mt-2">

                        <!-- 4 COLONNES -->
                        <div class="grid grid-cols-4 flex-1 gap-4">

                            <!-- Screenshot -->
                            <div class="flex items-center gap-2 truncate">
                                <i data-lucide="camera" class="w-4 h-4 text-slate-500 shrink-0"></i>
                                <span class="truncate" x-text="screenshotName"></span>
                            </div>

                            <!-- HTML -->
                            <div class="flex items-center gap-2 truncate">
                                <i data-lucide="file-text" class="w-4 h-4 text-slate-500 shrink-0"></i>
                                <span class="truncate" x-text="htmlName || 'No HTML'"></span>
                            </div>

                            <!-- Application -->
                            <div class="flex items-center gap-2 truncate">
                                <i data-lucide="puzzle" class="w-4 h-4 text-slate-500 shrink-0"></i>
                                <span class="truncate" x-text="application"></span>
                            </div>

                            <!-- Page -->
                            <div class="flex items-center gap-2 truncate">
                                <i data-lucide="map-pin" class="w-4 h-4 text-slate-500 shrink-0"></i>
                                <span class="truncate" x-text="page"></span>
                            </div>

                        </div>

                        <!-- Bouton Edit -->
                        <button @click="screenshotFile=null;htmlFile=null;page='';contextSent=false;sessionID = crypto.randomUUID();"
                                class="ml-4 flex items-center gap-1 text-xs text-red-500 hover:text-red-600 transition">
                            <i data-lucide="pencil" class="w-3.5 h-3.5"></i>Edit
                        </button>

                    </div>
                </div>

            </div>

            <!-- CHAT AREA (scrollable) -->
            <div class="flex flex-col flex-1 overflow-hidden">

                <!-- MESSAGES -->
                <div id="aoConversation" class="flex-1 overflow-y-auto p-6 space-y-4 bg-slate-50 dark:bg-slate-900">
                    <template x-for="(m, i) in messages" :key="i">
                        <div>
                            <!-- MESSAGE NORMAL -->
                            <template x-if="m.type === 'message'">
                                <div class="flex items-end gap-2"
                                     :class="m.role === 'user' ? 'justify-end' : 'justify-start'">

                                    <!-- Avatar assistant -->
                                    <div x-show="m.role !== 'user'"
                                         class="h-8 w-8 rounded-full bg-slate-200 dark:bg-slate-800 flex items-center justify-center shrink-0">
                                        <i data-lucide="bot" class="w-4 h-4 text-sky-500"></i>
                                    </div>

                                    <!-- Bulle -->
                                    <div class="max-w-[90%] px-4 py-2.5 rounded-xl text-sm leading-relaxed shadow-sm"
                                         :class="m.role==='user' ? 'bg-blue-600 text-white rounded-br-sm' : 'bg-slate-200 dark:bg-slate-800 rounded-bl-sm'">
                                        <span x-html="formatAI(m.text)"></span>
                                    </div>

                                    <!-- Avatar user -->
                                    <div x-show="m.role === 'user'"
                                         class="h-8 w-8 rounded-full bg-blue-600 !text-white flex items-center justify-center shrink-0">
                                        <i data-lucide="user" class="w-4 h-4 text-slate-700 dark:text-slate-200"></i>
                                    </div>

                                </div>
                            </template>

                            <!-- PROPOSALS MESSAGE -->
                            <template x-if="m.type === 'proposals'">
                                <div class="space-y-3">
                                    <template x-for="(p, pi) in m.proposals" :key="pi">
                                        <div class="group rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-200 dark:bg-slate-800 p-4 shadow-sm max-w-md ml-10">
                                            <div class="flex justify-between items-start gap-3">
                                                <div class="flex-1 space-y-2 min-w-0">

                                                    <!-- Badge type + confiance -->
                                                    <div class="flex items-center gap-2">
                                                        <span class="text-xs font-semibold bg-blue-100 dark:bg-blue-900/40 text-blue-600 px-2 py-0.5 rounded-full uppercase tracking-wide">XPath</span>
                                                        <div class="flex items-center gap-1">
                                                            <div class="h-1.5 w-16 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
                                                                <div class="h-full bg-green-500 rounded-full" :style="'width:' + (p.confidence||0) + '%'"></div>
                                                            </div>
                                                            <span class="text-xs text-slate-400" x-text="(p.confidence || 0) + '%'"></span>
                                                        </div>
                                                    </div>

                                                    <!-- Nom -->
                                                    <p class="font-semibold text-base" x-text="p.name || p.object"></p>

                                                    <!-- Valeur (xpath/id) -->
                                                    <div class="flex items-center gap-2 bg-slate-100 dark:bg-slate-700 rounded-lg px-3 py-1.5">
                                                        <code class="text-xs flex-1 break-all" x-text="p.value"></code>
                                                        <button @click="navigator.clipboard.writeText(p.value)"
                                                                class="shrink-0 text-slate-400 hover:text-blue-500 transition"
                                                                title="Copier">
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-4 12h6a2 2 0 002-2v-8a2 2 0 00-2-2h-6a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                                        </button>
                                                    </div>

                                                    <!-- Description -->
                                                    <p class="text-xs text-slate-500" x-text="p.description"></p>

                                                    <!-- Screenshot -->
                                                    <img x-show="p.screenshotFilename"
                                                         :src="getScreenshotUrl(p.screenshotFilename)"
                                                         class="mt-2 max-w-[200px] rounded-lg border border-slate-200 dark:border-slate-700 shadow-sm">
                                                </div>

                                                <!-- Boutons accept/reject -->
                                                <div class="flex flex-col gap-2 shrink-0">
                                                    <button @click="acceptProposalFromMessage(i, pi)"
                                                            class="h-8 w-8 rounded-lg bg-green-500 hover:bg-green-600 text-white flex items-center justify-center transition shadow-sm"
                                                            title="Accepter">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg>
                                                    </button>
                                                    <button @click="rejectProposalFromMessage(i, pi)"
                                                            class="h-8 w-8 rounded-lg bg-red-500 hover:bg-red-600 text-white flex items-center justify-center transition shadow-sm"
                                                            title="Rejeter">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/></svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>

                <!-- INPUT -->
                <div class="border-t border-slate-200 dark:border-slate-700 p-4 flex-shrink-0">
                    <div class="flex items-end gap-2 rounded-xl bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 p-2 focus-within:border-blue-500 transition">

                        <textarea rows="1" x-model="chatInput"
                                @keydown.enter.prevent="if(contextReady) sendChat()"
                                :placeholder="$store.labels.getLabel('applicationObject','chatplaceholder')"
                                class="flex-1 resize-none bg-transparent text-sm focus:outline-none px-2 py-1.5 max-h-32">
                        </textarea>

                        <button @click="sendChat()"
                             :disabled="!contextReady"
                             :class="contextReady ? 'bg-blue-600 hover:bg-blue-700' : 'bg-slate-400 cursor-not-allowed'"
                             class="h-9 w-9 rounded-lg text-white flex items-center justify-center transition">
                             <i data-lucide="send" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    function aoModal() {
        return {
            open: false,

            isFullscreen: false,
            application: 'Games',
            page: '',
            html: '',
            htmlFile: null,
            htmlName: '',
            screenshotBase64: '',
            screenshotSize: 0,
            screenshotName: '',
            screenshotFile: null,

            newTarget: '',
            targets: [],
            messages: [],
            chatInput: '',
            proposals: [],

            error: '',

            // IA
            ws: null,
            connected: false,
            sessionID: null,
            contextSent: false,

            /* =========================
               OPEN MODAL ACTION : INIT STATE AND FIRST MESSAGE
            ========================= */

            openModal(data = {}) {
                this.open = true;
                this.page = data.page || '';
                this.html = data.html || '';
                this.application = data.application || '';

                this.messages = [];
                this.targets = [];
                this.error = '';

                this.sessionID = crypto.randomUUID();

                this.connectWebSocket();

                const firstMessage = Alpine.store('labels').getLabel('applicationObject','firstmessage');

                this.simulateStream(firstMessage);

                /*
                // Message d'accueil
                this.messages.push({
                    role: 'assistant',
                    type: 'message',
                    text: Alpine.store('labels').getLabel('applicationObject','firstmessage')
                });


                // Initial proposal (facultatif)
                this.messages.push({
                    role: 'assistant',
                    type: 'proposals',
                    proposals: [{
                        name: 'Test Button',
                        object: 'BTN_TEST',
                        value: '//button[@id="test"]',
                        description: 'Bouton de test',
                        confidence: 95,
                        screenshotFilename: null
                    }]
                });
                */
            },

            /* =========================
               SIMULATE STREAM FOR THE FIRST CALL ONLY
            ========================= */
            simulateStream(text) {
                const words = text.split(" ");
                let index = 0;

                const streamNext = () => {
                    if (index >= words.length) {
                        const last = this.messages[this.messages.length - 1];
                        if (last) last.streaming = false;
                        return;
                    }

                    this.appendAI(words[index] + " ");
                    index++;

                    let delay = 30 + Math.random() * 40;

                    if (words[index - 1].endsWith(".")) {
                        delay += 200;
                    }

                    setTimeout(streamNext, delay);
                };

                streamNext();
            },

            close() {
                this.open = false;
            },

            get contextReady() {
                return this.screenshotFile && this.application && this.page;
            },

            /* =========================
               WEBSOCKET
            ========================= */
            connectWebSocket() {
                if (this.ws && this.ws.readyState === 1) return;

                const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
                const host = window.location.host;

                // Build WebSocket URL
                const wsUrl = `${protocol}${host}${window.appContext}/api/ws/AIWebSocket`;
                console.debug("WebSocket URL:", wsUrl);

                this.ws = new WebSocket(wsUrl);

                this.ws.onopen = () => {
                    this.connected = true;
                };

                this.ws.onclose = () => {
                    this.connected = false;
                };

                this.ws.onerror = () => {
                    this.connected = false;
                };

                this.ws.onmessage = (event) => {

                    let parsed;
                    try { parsed = JSON.parse(event.data); }
                    catch { return; }

                    const type = parsed.type || "chat";

                    if (type === "ao_proposals") {
                        try {
                            const obj = parsed.data;

                            const proposalMessage = {
                                role: 'assistant',
                                type: 'proposals',
                                proposals: [{
                                    name: obj.object || obj.name || 'unknown',
                                    object: obj.object || obj.name || 'unknown',
                                    value: obj.value || '',
                                    description: obj.description || '',
                                    confidence: obj.confidence || 0,
                                    screenshotFilename: obj.screenshotFilename || null
                                }]
                            };

                            this.messages = [...this.messages, proposalMessage];
                        } catch (e) {
                            console.error("Failed to parse AO proposal", e);
                        }
                        return;
                    }

                    // Chat streaming simple
                    if (parsed.data) {
                        this.appendAI(parsed.data);
                    }
                };
            },


            /* =========================
               IA STREAM
            ========================= */
            appendAI(chunk) {
                const last = this.messages[this.messages.length - 1];

                if (!last || last.role !== 'assistant' || last.streaming !== true || last.type !== 'message') {
                    this.messages.push({
                        role: 'assistant',
                        type: 'message',
                        text: chunk,
                        streaming: true
                    });

                    this.messages = [...this.messages];

                    this.$nextTick(() => {
                        lucide.createIcons();
                    });

                } else {
                    last.text += chunk;
                    this.messages = [...this.messages];
                }
            },


            /* =========================
               FORM FILES
            ========================= */
            handleFiles(e) {
                const files = e.target.files;
                for (let file of files) {
                    if (file.type.startsWith("image/")) {
                        this.handleScreenshot({ target: { files: [file] } });
                    }
                    if (file.name.endsWith(".html") || file.name.endsWith(".htm")) {
                        this.handleHtmlFile({ target: { files: [file] } });
                    }
                }
            },

            handleHtmlFile(e) {
                const f = e.target.files[0];
                if (!f) return;
                this.htmlFile = f;
                this.htmlName = f.name;

                this.html = ''; // reset

                const reader = new FileReader();
                reader.onload = (ev) => {
                    this.html = ev.target.result;
                    console.debug("HTML loaded, length:", this.html.length);
                };
                reader.readAsText(f);
            },

            handleScreenshot(e) {
                const file = e.target.files[0];
                if (!file) return;

                this.screenshotFile = file;
                if (file.size > 6 * 1024 * 1024) {
                    this.error = "Image too large (>6MB)";
                    return;
                }

                this.screenshotName = file.name;

                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = new Image();
                    img.onload = () => {
                        // STOCKER les dimensions originales AVANT compression
                        this.originalWidth = img.width;
                        this.originalHeight = img.height;

                        // Canvas compression
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        const MAX_W = 1920;
                        const ratio = Math.min(1, MAX_W / img.width);

                        canvas.width = img.width * ratio;
                        canvas.height = img.height * ratio;

                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                        const base64 = canvas.toDataURL('image/jpeg', 0.7);

                        this.screenshotBase64 = base64;
                        this.screenshotSize = base64.length;

                        console.log("Original:", this.originalWidth, "x", this.originalHeight);
                        console.log("Canvas:", canvas.width, "x", canvas.height);
                    };

                    img.src = ev.target.result;
                };

                reader.readAsDataURL(file);
            },


            /* =========================
               PROPOSALS
            ========================= */
            acceptProposalFromMessage(messageIndex, proposalIndex) {
                const proposal = this.messages[messageIndex].proposals[proposalIndex];
                this.acceptProposalObject(proposal);

                this.messages[messageIndex].proposals.splice(proposalIndex, 1);

                if (this.messages[messageIndex].proposals.length === 0) {
                    this.messages.splice(messageIndex, 1);
                }
            },

            rejectProposalFromMessage(messageIndex, proposalIndex) {
                this.messages[messageIndex].proposals.splice(proposalIndex, 1);

                if (this.messages[messageIndex].proposals.length === 0) {
                    this.messages.splice(messageIndex, 1);
                }
            },

            /*
            CALL API IF PROPOSAL ACCEPTED
             */
            acceptProposalObject(p) {

                if (!p.screenshotFilename) {
                    console.warn("No screenshot for this AO, skipping upload file");
                }

                // Construire le FormData pour le servlet
                const formData = new FormData();
                formData.append("application", this.application);        // obligatoire côté servlet
                formData.append("object", p.object || p.name);    // nom de l'AO
                formData.append("value", p.value || "");          // xpath ou valeur
                formData.append("xOffset", p.xOffset || "0");     // optionnel
                formData.append("yOffset", p.yOffset || "0");     // optionnel

                // Ajouter le fichier screenshot temp si présent
                if (p.screenshotFilename) {
                    const screenshotUrl = this.getScreenshotUrl(p.screenshotFilename);

                    // Récupérer le fichier via fetch et le mettre dans FormData
                    fetch(screenshotUrl)
                        .then(resp => resp.blob())
                        .then(blob => {
                            const file = new File([blob], p.screenshotFilename, { type: blob.type });
                            formData.append("file", file);

                            // POST vers ton servlet de création
                            this.sendAOFormData(formData);
                        })
                        .catch(err => {
                            console.error("Failed to fetch temp screenshot", err);
                        });
                } else {
                    this.sendAOFormData(formData);
                }
            },

            sendAOFormData(formData) {

                const url = `${window.appContext}/CreateApplicationObject`;

                fetch(url, {
                    method: "POST",
                    body: formData
                })
                    .then(resp => resp.json())
                    .then(data => {

                        if (data.messageType === "OK") {

                            notifyInModal(
                                "success",
                                "Settings successfully saved",
                                "#modalNotify"
                            );

                        } else {
                            notifyInModal(
                                "error",
                                "Failed to save AO: " + data.message,
                                "#modalNotify"
                            );
                        }
                    })
                    .catch(err => {
                        console.error("Error sending AO form data", err);
                    });
            },


            getScreenshotUrl(fileName) {
                return `${window.location.origin}${window.appContext}/api/applicationobjects/screenshot/temp/${fileName}`;
            },


            /* =========================
               CHAT
            ========================= */
            async sendChat() {

                const txt = this.chatInput.trim();
                if (!txt || !this.contextReady) return;

                this.messages.push({ role: 'user', type: 'message', text: txt });
                this.chatInput = '';
                this.error = '';

                if (window.lucide){
                    lucide.createIcons();
                }

                // FIRST CALL = upload + ao_generate
                if (!this.contextSent) {

                    const formData = new FormData();
                    formData.append("screenshot", this.screenshotFile);
                    if (this.htmlFile) formData.append("htmlFile", this.htmlFile);

                    const uploadUrl = `${window.appContext}/api/applicationobjects/uploadFiles`;

                    const uploadResp = await fetch(uploadUrl, {
                        method: "POST",
                        body: formData
                    });

                    if (!uploadResp.ok) {
                        this.error = "Upload failed";
                        return;
                    }

                    const uploadData = await uploadResp.json();

                    const payload = {
                        subject: "ao_generate",
                        sender: getUser().login,
                        sessionID: this.sessionID,
                        application: this.application,
                        page: this.page,
                        screenshotName: uploadData.screenshotName,
                        screenshotPath: uploadData.screenshotPath,
                        htmlName: uploadData.htmlName || null,
                        htmlPath: uploadData.htmlPath || null,
                        content: txt
                    };

                    this.ws.send(JSON.stringify(payload));

                    this.contextSent = true;
                }

                //NEXT CALLS = ao_generate_continue
                else {

                    const payload = {
                        subject: "ao_generate_continue",
                        sender: getUser().login,
                        sessionID: this.sessionID,
                        application: this.application,
                        page: this.page,
                        screenshotName: uploadData.screenshotName,
                        screenshotPath: uploadData.screenshotPath,
                        htmlName: uploadData.htmlName || null,
                        htmlPath: uploadData.htmlPath || null,
                        content: txt
                    };

                    this.ws.send(JSON.stringify(payload));
                }
            },

            /* =========================
               FORMAT TEXT RECEIVED FROM AI
            ========================= */
            formatAI(text) {
                if (!text) return '';

                try {
                    const rawHtml = marked.parse(text);

                    const clean = DOMPurify.sanitize(rawHtml, {
                        ALLOWED_TAGS: [
                            'b','i','strong','em','ul','ol','li','p','div','span',
                            'code','pre','br','hr','h1','h2','h3','h4','table','thead',
                            'tbody','tr','th','td','blockquote'
                        ],
                        ALLOWED_ATTR: ['class']
                    });

                    return clean;

                } catch (e) {
                    return text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                }
            }
        }
    }
</script>